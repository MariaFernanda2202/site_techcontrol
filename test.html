<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Formulário com Geolocalização</title>
  <style>
    label { display: block; margin-top: 10px; }
    input, textarea { width: 300px; padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>

  <h2>Formulário de Endereço</h2>

  <form id="formulario">
    <label for="cep">CEP:</label>
    <input type="text" id="cep" maxlength="8" required>

    <label for="address">Endereço:</label>
    <input type="text" id="address" name="address" required>

    <label for="numero">Número:</label>
    <input type="text" id="numero" name="numero" required>

    <label for="cidade">Cidade:</label>
    <input type="text" id="cidade" name="cidade" required>

    <label for="estado">Estado:</label>
    <input type="text" id="estado" name="estado" required>

    <!-- Campos escondidos para envio -->
    <input type="hidden" id="latitude" name="latitude">
    <input type="hidden" id="longitude" name="longitude">

    <button type="submit">Enviar</button>
  </form>

  <script>
    // Passo 1: Buscar dados do CEP e preencher rua, cidade e estado
    document.getElementById('cep').addEventListener('blur', async () => {
      const cep = document.getElementById('cep').value.replace(/\D/g, '');
      if (cep.length !== 8) return;

      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        if (!data.erro) {
          document.getElementById('address').value = data.logradouro;
          document.getElementById('cidade').value = data.localidade;
          document.getElementById('estado').value = data.uf;
        }
      } catch (e) {
        alert('Erro ao buscar CEP');
      }
    });

    // Passo 2: Quando digitar o número, buscar latitude e longitude
    document.getElementById('numero').addEventListener('blur', async () => {
      const rua = document.getElementById('address').value;
      const numero = document.getElementById('numero').value;
      const cidade = document.getElementById('cidade').value;
      const estado = document.getElementById('estado').value;

      if (!rua || !numero || !cidade || !estado) return;

      const addressCompleto = `${rua}, ${numero}, ${cidade}, ${estado}, Brasil`;

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressCompleto)}`;

      try {
        const response = await fetch(url, {
          headers: {
            'Accept-Language': 'pt-BR',
            'User-Agent': 'SeuProjeto/1.0 (seu-email@exemplo.com)' // personalize se for público
          }
        });

        const results = await response.json();

        if (results.length > 0) {
          document.getElementById('latitude').value = results[0].lat;
          document.getElementById('longitude').value = results[0].lon;
        } else {
          alert('Local não encontrado.');
        }

      } catch (e) {
        alert('Erro ao buscar coordenadas.');
      }
    });

    // Apenas demonstração de envio
    document.getElementById('formulario').addEventListener('submit', function(e) {
      e.preventDefault();
      const dados = new FormData(this);
      for (const [chave, valor] of dados.entries()) {
        console.log(`${chave}: ${valor}`);
      }
      alert('Formulário enviado com sucesso!');
    });
  </script>

</body>
</html>
